{% extends "base.html" %}

{% block title %}Vulnerability Scanner - NET ARMOR{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header text-center">
                    <h2><i class="fas fa-shield-virus me-2"></i>Vulnerability Scanner</h2>
                    <p class="mb-0">Advanced security vulnerability detection and assessment</p>
                </div>
                <div class="card-body">
                    <form id="vulnScanForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <span class="input-group-text">ðŸŽ¯</span>
                                    <input type="text" class="form-control" id="targetInput" 
                                           placeholder="Enter target (IP/domain, e.g., 192.168.1.1 or example.com)" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search me-1"></i>Start Scan
                                </button>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Scan Type:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="scanType" id="quickScan" value="quick" checked>
                                    <label class="form-check-label" for="quickScan">
                                        Quick Scan (Top 100 ports)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="scanType" id="comprehensiveScan" value="comprehensive">
                                    <label class="form-check-label" for="comprehensiveScan">
                                        Comprehensive Scan (Top 1000 ports)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="scanType" id="customScan" value="custom">
                                    <label class="form-check-label" for="customScan">
                                        Custom Port Range
                                    </label>
                                </div>
                                <div id="customPortRange" class="mt-2" style="display: none;">
                                    <input type="text" class="form-control form-control-sm" 
                                           id="portRange" placeholder="e.g., 1-1000 or 80,443,8080">
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Vulnerability Tests:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="cveCheck" checked>
                                    <label class="form-check-label" for="cveCheck">CVE Database Lookup</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="serviceDetection" checked>
                                    <label class="form-check-label" for="serviceDetection">Service Detection</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="osDetection">
                                    <label class="form-check-label" for="osDetection">OS Fingerprinting</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="webVulns">
                                    <label class="form-check-label" for="webVulns">Web Vulnerabilities</label>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Scan Progress -->
                    <div id="scanProgress" class="mt-4" style="display: none;">
                        <h5><i class="fas fa-cog fa-spin me-2"></i>Scanning in Progress</h5>
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" id="progressBar"></div>
                        </div>
                        <div id="scanStatus">Initializing scan...</div>
                    </div>

                    <!-- Results Section -->
                    <div id="vulnResults" class="mt-4" style="display: none;">
                        <div class="row">
                            <!-- Summary Cards -->
                            <div class="col-md-3 mb-3">
                                <div class="card bg-danger">
                                    <div class="card-body text-center">
                                        <h4 id="criticalCount">0</h4>
                                        <small>Critical</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-warning">
                                    <div class="card-body text-center">
                                        <h4 id="highCount">0</h4>
                                        <small>High</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-info">
                                    <div class="card-body text-center">
                                        <h4 id="mediumCount">0</h4>
                                        <small>Medium</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-success">
                                    <div class="card-body text-center">
                                        <h4 id="lowCount">0</h4>
                                        <small>Low</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Results -->
                        <ul class="nav nav-tabs" id="vulnTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="ports-tab" data-bs-toggle="tab" data-bs-target="#ports-content" type="button" role="tab">
                                    <i class="fas fa-door-open me-1"></i>Open Ports
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="vulnerabilities-tab" data-bs-toggle="tab" data-bs-target="#vulnerabilities-content" type="button" role="tab">
                                    <i class="fas fa-bug me-1"></i>Vulnerabilities
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="services-tab" data-bs-toggle="tab" data-bs-target="#services-content" type="button" role="tab">
                                    <i class="fas fa-cogs me-1"></i>Services
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="recommendations-tab" data-bs-toggle="tab" data-bs-target="#recommendations-content" type="button" role="tab">
                                    <i class="fas fa-lightbulb me-1"></i>Recommendations
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content mt-3" id="vulnTabContent">
                            <div class="tab-pane fade show active" id="ports-content" role="tabpanel">
                                <div id="portsResults"></div>
                            </div>
                            <div class="tab-pane fade" id="vulnerabilities-content" role="tabpanel">
                                <div id="vulnerabilitiesResults"></div>
                            </div>
                            <div class="tab-pane fade" id="services-content" role="tabpanel">
                                <div id="servicesResults"></div>
                            </div>
                            <div class="tab-pane fade" id="recommendations-content" role="tabpanel">
                                <div id="recommendationsResults"></div>
                            </div>
                        </div>

                        <!-- Report Generation -->
                        <div class="mt-4 text-center">
                            <button class="btn btn-outline-primary me-2" onclick="generateReport('executive')">
                                <i class="fas fa-file-alt me-1"></i>Executive Summary
                            </button>
                            <button class="btn btn-outline-primary me-2" onclick="generateReport('technical')">
                                <i class="fas fa-file-code me-1"></i>Technical Report
                            </button>
                            <button class="btn btn-outline-secondary" onclick="exportToCSV()">
                                <i class="fas fa-table me-1"></i>Export to CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.vulnerability-card {
    border-left: 4px solid;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.vulnerability-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.vuln-critical { border-left-color: #dc3545; }
.vuln-high { border-left-color: #fd7e14; }
.vuln-medium { border-left-color: #ffc107; }
.vuln-low { border-left-color: #28a745; }

.port-item {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 10px;
    margin: 5px 0;
    border-left: 3px solid #007bff;
}

.service-badge {
    background: linear-gradient(45deg, #5733ff, #7c4dff);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
}

.progress {
    height: 25px;
    background: rgba(255, 255, 255, 0.1);
}

.progress-bar {
    background: linear-gradient(45deg, #5733ff, #7c4dff);
}
</style>

<script>
document.getElementById('vulnScanForm').addEventListener('submit', function(e) {
    e.preventDefault();
    startVulnerabilityScan();
});

// Show/hide custom port range input
document.querySelectorAll('input[name="scanType"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const customRange = document.getElementById('customPortRange');
        customRange.style.display = this.value === 'custom' ? 'block' : 'none';
    });
});

async function startVulnerabilityScan() {
    const target = document.getElementById('targetInput').value.trim();
    if (!target) return;

    const scanType = document.querySelector('input[name="scanType"]:checked').value;
    const portRange = document.getElementById('portRange').value;

    const options = {
        cve_lookup: document.getElementById('cveCheck').checked,
        service_detection: document.getElementById('serviceDetection').checked,
        os_detection: document.getElementById('osDetection').checked,
        web_vulns: document.getElementById('webVulns').checked
    };

    // Show progress
    document.getElementById('scanProgress').style.display = 'block';
    document.getElementById('vulnResults').style.display = 'none';

    try {
        const response = await fetch('/api/vulnerability_scan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                target: target,
                scan_type: scanType,
                port_range: portRange,
                options: options
            })
        });

        // Simulate progress updates
        simulateProgress();

        const result = await response.json();
        
        if (result.success) {
            displayVulnerabilityResults(result.data);
        } else {
            alert('Scan failed: ' + result.message);
        }
    } catch (error) {
        alert('Error performing scan: ' + error.message);
    } finally {
        document.getElementById('scanProgress').style.display = 'none';
    }
}

function simulateProgress() {
    const progressBar = document.getElementById('progressBar');
    const statusDiv = document.getElementById('scanStatus');
    
    const steps = [
        'Resolving target...',
        'Scanning ports...',
        'Detecting services...',
        'Checking vulnerabilities...',
        'Generating report...'
    ];
    
    let progress = 0;
    let stepIndex = 0;
    
    const interval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 100) progress = 100;
        
        progressBar.style.width = progress + '%';
        
        if (stepIndex < steps.length) {
            statusDiv.textContent = steps[stepIndex];
            stepIndex++;
        }
        
        if (progress >= 100) {
            clearInterval(interval);
            statusDiv.textContent = 'Scan completed!';
        }
    }, 800);
}

function displayVulnerabilityResults(data) {
    // Update summary cards
    document.getElementById('criticalCount').textContent = data.summary.critical;
    document.getElementById('highCount').textContent = data.summary.high;
    document.getElementById('mediumCount').textContent = data.summary.medium;
    document.getElementById('lowCount').textContent = data.summary.low;

    // Display open ports
    displayOpenPorts(data.open_ports);
    
    // Display vulnerabilities
    displayVulnerabilities(data.vulnerabilities);
    
    // Display services
    displayServices(data.services);
    
    // Display recommendations
    displayRecommendations(data.recommendations);

    document.getElementById('vulnResults').style.display = 'block';
}

function displayOpenPorts(ports) {
    const container = document.getElementById('portsResults');
    
    if (ports.length === 0) {
        container.innerHTML = '<p class="text-muted">No open ports detected.</p>';
        return;
    }
    
    container.innerHTML = `
        <div class="row">
            ${ports.map(port => `
                <div class="col-md-6 mb-2">
                    <div class="port-item">
                        <strong>Port ${port.number}/${port.protocol}</strong>
                        <span class="service-badge float-end">${port.service}</span>
                        <br><small>${port.description || 'Standard service'}</small>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function displayVulnerabilities(vulnerabilities) {
    const container = document.getElementById('vulnerabilitiesResults');
    
    if (vulnerabilities.length === 0) {
        container.innerHTML = '<p class="text-success">âœ… No vulnerabilities detected!</p>';
        return;
    }
    
    container.innerHTML = vulnerabilities.map(vuln => `
        <div class="card vulnerability-card vuln-${vuln.severity}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="card-title">${vuln.name}</h6>
                        <p class="card-text">${vuln.description}</p>
                        ${vuln.cve ? `<small><strong>CVE:</strong> ${vuln.cve}</small>` : ''}
                    </div>
                    <span class="badge bg-${getSeverityColor(vuln.severity)}">${vuln.severity.toUpperCase()}</span>
                </div>
                ${vuln.solution ? `
                    <div class="mt-2">
                        <strong>Solution:</strong> ${vuln.solution}
                    </div>
                ` : ''}
            </div>
        </div>
    `).join('');
}

function displayServices(services) {
    const container = document.getElementById('servicesResults');
    
    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-dark table-striped">
                <thead>
                    <tr>
                        <th>Port</th>
                        <th>Service</th>
                        <th>Version</th>
                        <th>Status</th>
                        <th>Risk Level</th>
                    </tr>
                </thead>
                <tbody>
                    ${services.map(service => `
                        <tr>
                            <td>${service.port}</td>
                            <td>${service.name}</td>
                            <td>${service.version || 'Unknown'}</td>
                            <td><span class="badge ${service.status === 'running' ? 'bg-success' : 'bg-warning'}">${service.status}</span></td>
                            <td><span class="badge bg-${getSeverityColor(service.risk_level)}">${service.risk_level}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function displayRecommendations(recommendations) {
    const container = document.getElementById('recommendationsResults');
    
    container.innerHTML = `
        <div class="row">
            ${recommendations.map((rec, index) => `
                <div class="col-md-12 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6><i class="fas fa-lightbulb me-2"></i>${rec.title}</h6>
                            <p>${rec.description}</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-${getPriorityColor(rec.priority)}">${rec.priority} Priority</span>
                                <small class="text-muted">Impact: ${rec.impact}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function getSeverityColor(severity) {
    const colors = {
        'critical': 'danger',
        'high': 'warning',
        'medium': 'info',
        'low': 'success'
    };
    return colors[severity] || 'secondary';
}

function getPriorityColor(priority) {
    const colors = {
        'high': 'danger',
        'medium': 'warning',
        'low': 'success'
    };
    return colors[priority] || 'secondary';
}

function generateReport(type) {
    alert(`Generating ${type} report...`);
    // Implementation for report generation
}

function exportToCSV() {
    alert('Exporting vulnerability data to CSV...');
    // Implementation for CSV export
}
</script>
{% endblock %}
